<!-- /templates/index.html -->

<!doctype html>
<html lang="en">
    <head>
        <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <title>Movie Bot</title>
    </head>
    <body>
        <div class="container h-100">
        <div class="row align-items-center h-100">
            <div class="col-md-8 col-sm-12 mx-auto">
                <div class="h-100 justify-content-center">
                    <div class="chat-container" style="overflow: auto; max-height: 80vh">
                        <!-- chat messages -->
                    </div>
                    <form id="target">
                        <input class="input" type="text" value="" placeholder="Enter message..." id="input_message"/>
                        <input type="submit" hidden>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"></script>
    <script src="https://js.pusher.com/4.1/pusher.min.js"></script>

    <script>
        const pusher = new Pusher('76961cbaed147db37fd5', {
        cluster: 'ap2',
        encrypted: true
        });

        // Subscribe to movie_bot channel
        const channel = pusher.subscribe('movie_bot');

        // bind new_message event to movie_bot channel
        channel.bind('new_message', function(data) {
            console.log(data)
            // Append human message
            $('.chat-container').append(`
                <div class="chat-message col-md-5 human-message">
                    ${data.human_message}
                </div>
            `)
            
            // Append bot message
            $('.chat-container').append(`
                <div class="chat-message col-md-5 offset-md-7 bot-message">
                ${data.bot_message}
                </div>
            `)
        });

        $(function() {
            function submit_message(message) {
        
                $.post( "/send_message", {
                    message: message, 
                    socketId: pusher.connection.socket_id
                }, handle_response);
                
                function handle_response(data) {
                    // append the bot repsonse to the div
                    console.log(data.message)
                    $('.chat-container').append(`
                        <div class="chat-message col-md-5 offset-md-7 bot-message">
                            ${data.message}
                        </div>
                    `)
                    // remove the loading indicator
                    $( "#loading" ).remove();
                }
            }

            $('#target').on('submit', function(e){
                e.preventDefault();
                const input_message = $('#input_message').val()
                // return if the user does not enter any text
                if (!input_message) {
                    return
                }
                
                $('.chat-container').append(`
                    <div class="chat-message col-md-5 human-message">
                        ${input_message}
                    </div>
                `)
                
                // loading 
                $('.chat-container').append(`
                    <div class="chat-message text-center col-md-2 offset-md-10 bot-message" id="loading">
                        <b>...</b>
                    </div>
                `)
                
                // clear the text input 
                $('#input_message').val('')
                
                // send the message
                submit_message(input_message)
            });
        });
    </script>
    </body>
</html>
